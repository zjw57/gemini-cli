name: 'Publish Release'
description: 'Publishes the gemini-cli packages to npm and creates a GitHub release.'

inputs:
  release-version:
    description: 'The version to release (e.g., 0.1.11).'
    required: true
  npm-tag:
    description: 'The npm tag to publish with (e.g., latest, preview, nightly).'
    required: true
  wombat-token-core:
    description: 'The npm token for the @google/gemini-cli-core package.'
    required: true
  wombat-token-cli:
    description: 'The npm token for the @google/gemini-cli package.'
    required: true
  github-token:
    description: 'The GitHub token for creating the release.'
    required: true
  dry-run:
    description: 'Whether to run in dry-run mode.'
    type: 'string'
    required: true
  release-tag:
    description: 'The release tag for the release (e.g., v0.1.11).'
    required: true
  previous-tag:
    description: 'The previous tag to use for generating release notes.'
    required: true
  skip-github-release:
    description: 'Whether to skip creating a GitHub release.'
    type: 'boolean'
    required: false
    default: false
  working-directory:
    description: 'The working directory to run the steps in.'
    required: false
    default: '.'
  force-skip-tests:
    description: 'Skip tests and validation'
    required: false
    default: false
  branch-name:
    description: 'The name of the release branch.'
  skip-branch-cleanup:
    description: 'Whether to skip cleaning up the release branch.'
    type: 'boolean'
    required: false
    default: false
  gemini_api_key:
    description: 'The API key for running integration tests.'
    required: true

runs:
  using: 'composite'
  steps:
    - name: 'Configure npm for publishing'
      uses: 'actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020'
      with:
        node-version-file: '${{ inputs.working-directory }}/.nvmrc'
        registry-url: 'https://wombat-dressing-room.appspot.com'
        scope: '@google'

    - name: 'ğŸ“¦ Publish @google/gemini-cli-core'
      working-directory: '${{ inputs.working-directory }}'
      env:
        NODE_AUTH_TOKEN: '${{ inputs.wombat-token-core }}'
      shell: 'bash'
      run: |
        if [ "${{ inputs.dry-run }}" == "true" ]; then
          npm publish --dry-run --workspace="@google/gemini-cli-core" --no-tag
        else
          npm publish --workspace="@google/gemini-cli-core" --no-tag
        fi

    - name: 'ğŸ”— Install latest core package'
      working-directory: '${{ inputs.working-directory }}'
      if: "${{ inputs.dry-run != 'true' }}"
      shell: 'bash'
      run: |
        npm install "@google/gemini-cli-core@${{ inputs.release-version }}" \
        --workspace="@google/gemini-cli" \
        --save-exact

    - name: 'ğŸ“¦ Publish @google/gemini-cli'
      working-directory: '${{ inputs.working-directory }}'
      env:
        NODE_AUTH_TOKEN: '${{ inputs.wombat-token-cli }}'
      shell: 'bash'
      run: |
        if [ "${{ inputs.dry-run }}" == "true" ]; then
          npm publish --dry-run --workspace="@google/gemini-cli" --no-tag
        else
          npm publish --workspace="@google/gemini-cli" --no-tag
        fi

    - name: 'ğŸ”¬ Verify NPM release by version'
      uses: './.github/actions/verify-release'
      if: "${{ inputs.dry-run != 'true' && inputs.force-skip-tests != 'true' }}"
      with:
        npm-package: '@google/gemini-cli@${{ inputs.release-version }}'
        expected-version: '${{ inputs.release-version }}'
        ref: '${{ inputs.branch-name }}'
        gemini_api_key: '${{ inputs.gemini_api_key }}'

    - name: 'ğŸ·ï¸ Tag release'
      uses: './.github/actions/tag-npm-release'
      if: "${{ inputs.dry-run != 'true' }}"
      with:
        channel: '${{ inputs.npm-tag }}'
        version: '${{ inputs.release-version }}'
        dry-run: '${{ inputs.dry-run }}'
        wombat-token-core: '${{ inputs.wombat-token-core }}'
        wombat-token-cli: '${{ inputs.wombat-token-cli }}'

    - name: 'ğŸ Bundle'
      working-directory: '${{ inputs.working-directory }}'
      shell: 'bash'
      run: |
        npm run bundle

    - name: 'ğŸ‰ Create GitHub Release'
      working-directory: '${{ inputs.working-directory }}'
      if: "${{ inputs.dry-run != 'true' && inputs.skip-github-release != 'true' && inputs.npm-tag != 'dev' }}"
      env:
        GITHUB_TOKEN: '${{ inputs.github-token }}'
      shell: 'bash'
      run: |
        gh release create "${{ inputs.release-tag }}" \
          bundle/gemini.js \
          --target "${{ inputs.branch-name }}" \
          --title "Release ${{ inputs.release-tag }}" \
          --notes-start-tag "${{ inputs.previous-tag }}" \
          --generate-notes

    - name: 'ğŸ§¹ Clean up release branch'
      working-directory: '${{ inputs.working-directory }}'
      if: "${{ inputs.dry-run != 'true' && inputs.skip-branch-cleanup != 'true' }}"
      continue-on-error: true
      shell: 'bash'
      run: |
        echo "Cleaning up release branch ${{ inputs.branch-name }}..."
        git push origin --delete "${{ inputs.branch-name }}"
